<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Paper Analyzer - Analyze Your Exam Papers</title>

    <!-- Chart.js UMD build (v3.9.1) so Chart.getChart(...) works reliably -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        /* Full CSS (same visual style as before) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 40px; padding: 20px; }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }

        .upload-section {
            background: white; border-radius: 20px; padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 30px; text-align: center;
        }
        .upload-area {
            border: 3px dashed #667eea; border-radius: 15px; padding: 60px 20px;
            cursor: pointer; transition: all 0.3s; background: #f8f9ff;
        }
        .upload-area:hover { background: #e8ebff; border-color: #764ba2; }
        .upload-area.dragover { background: #d8e0ff; border-color: #764ba2; }
        .upload-icon { font-size: 4em; margin-bottom: 20px; }
        input[type="file"] { display: none; }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
            padding: 15px 40px; border: none; border-radius: 50px; font-size: 1.1em;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .loading { display: none; text-align: center; padding: 20px; color: #667eea; font-size: 1.2em; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .results { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .results h2 { color: #667eea; margin-bottom: 30px; font-size: 2em; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px;
            border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-number { font-size: 3em; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; opacity: 0.9; }

        .chart-container { margin: 30px 0; background: #f8f9ff; padding: 30px; border-radius: 15px; }
        .chart-title { color: #667eea; margin-bottom: 20px; font-size: 1.5em; }

        .topic-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .topic-tag { background: #667eea; color: white; padding: 10px 20px; border-radius: 25px; font-size: 0.9em; }

        .error { background: #ff6b6b; color: white; padding: 15px; border-radius: 10px; margin: 20px 0; display: none; }

        @media (max-width: 768px) {
          h1 { font-size: 2em; }
          .upload-section, .results { padding: 20px; }
          .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÑ Paper Analyzer</h1>
            <p class="subtitle">Upload your exam papers and discover patterns, chapters, and topics!</p>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>Drop your exam paper here or click to upload</h3>
                <p style="color:#666; margin-top:10px;">Supports PDF files up to 32MB</p>
                <input type="file" id="fileInput" accept=".pdf" />
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
            </div>
            <div class="error" id="errorMsg"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your paper... Please wait</p>
            </div>
        </div>

        <div class="results" id="results">
            <h2>üìä Analysis Results</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div class="stat-label">Total Questions Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalChapters">0</div>
                    <div class="stat-label">Chapters Identified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topChapter">-</div>
                    <div class="stat-label">Most Tested Chapter</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üìö Chapter Distribution</h3>
                <canvas id="chapterChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üéØ Top Topics</h3>
                <canvas id="topicChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üè∑Ô∏è Frequently Mentioned Topics</h3>
                <div class="topic-list" id="topicList"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMsg = document.getElementById('errorMsg');

        // Drag and drop
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', e => {
            e.preventDefault(); uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFile(files[0]);
        });

        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => { errorMsg.style.display = 'none'; }, 7000);
        }

        // Safe destroy using Chart.getChart (Chart.js v3+)
        function destroyChartIfExists(canvas) {
            try {
                if (!canvas) return;
                if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {
                    const c = Chart.getChart(canvas);
                    if (c && typeof c.destroy === 'function') c.destroy();
                } else if (canvas._chart_instance && typeof canvas._chart_instance.destroy === 'function') {
                    canvas._chart_instance.destroy();
                }
            } catch (e) {
                console.warn('Destroy chart error', e);
            }
        }

        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) { showError('Please upload a PDF'); return; }

            const formData = new FormData();
            formData.append('file', file);

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const resp = await fetch('/upload', { method: 'POST', body: formData });
                const contentType = resp.headers.get('content-type') || '';
                if (!resp.ok) {
                    // Try to display JSON error or plain text
                    if (contentType.includes('application/json')) {
                        const err = await resp.json();
                        throw new Error(err.error || JSON.stringify(err));
                    } else {
                        const text = await resp.text();
                        throw new Error(text || 'Upload failed with status ' + resp.status);
                    }
                }

                let data;
                if (contentType.includes('application/json')) {
                    data = await resp.json();
                } else {
                    const text = await resp.text();
                    throw new Error('Unexpected server response: ' + text);
                }

                if (!data.success) {
                    throw new Error(data.error || 'Server returned an error during analysis.');
                }

                renderResults(data);
            } catch (err) {
                console.error('Upload/display error:', err);
                showError(err.message || 'Failed to upload file. Check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderResults(data) {
            document.getElementById('totalQuestions').textContent = data.total_questions || 0;
            document.getElementById('totalChapters').textContent = Object.keys(data.chapters || {}).length;
            document.getElementById('topChapter').textContent = Object.keys(data.chapters || {})[0] || 'N/A';

            // Chapter chart
            const chapterCanvas = document.getElementById('chapterChart');
            destroyChartIfExists(chapterCanvas);
            if (typeof Chart !== 'undefined') {
                new Chart(chapterCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.chapters || {}),
                        datasets: [{ label: 'Frequency', data: Object.values(data.chapters || {}), backgroundColor: 'rgba(102,126,234,0.8)', borderColor: 'rgba(102,126,234,1)', borderWidth: 2 }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }

            // Topic chart
            const topicCanvas = document.getElementById('topicChart');
            destroyChartIfExists(topicCanvas);
            const topTopics = Object.entries(data.topics || {}).slice(0, 10);
            if (typeof Chart !== 'undefined') {
                new Chart(topicCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: topTopics.map(([t]) => t),
                        datasets: [{ label: 'Frequency', data: topTopics.map(([, c]) => c), backgroundColor: 'rgba(118,75,162,0.8)', borderColor: 'rgba(118,75,162,1)', borderWidth: 2 }]
                    },
                    options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } } }
                });
            }

            // Topic tags
            const topicList = document.getElementById('topicList');
            topicList.innerHTML = '';
            Object.entries(data.topics || {}).slice(0, 15).forEach(([t, c]) => {
                const tag = document.createElement('div');
                tag.className = 'topic-tag';
                tag.textContent = `${t} (${c})`;
                topicList.appendChild(tag);
            });

            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>